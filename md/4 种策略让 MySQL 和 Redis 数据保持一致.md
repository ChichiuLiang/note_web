> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/AfdTX9u9Qf8A2m6I69gInw)

> 👉 **这是一个或许对你有用****的社群**
> 
> 🐱 一对一交流 / 面试小册 / 简历优化 / 求职解惑，欢迎加入「[**芋道快速开发平台**](http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247576697&idx=1&sn=a5f8a37fe0c6f05509c5bed6244471a8&chksm=fa4bd3c8cd3c5aded28a6b68a9944ce671f3d2748644f71550c0468d75058e90dd378a1babe8&scene=21#wechat_redirect)」知识星球。下面是星球提供的部分资料： 
> 
> *   [《项目实战（视频）》](http://mp.weixin.qq.com/s?__biz=MzUxOTc4NjEyMw==&mid=2247561735&idx=1&sn=1b0a95d87fc647c3cf5e2b88576a8f55&chksm=f9f7e9e3ce8060f5809daa189fea465e95fa5445797f96fd8023f424c2acf4d31751a62792fc&scene=21#wechat_redirect)：从书中学，往事中 **“练”**
>     
> *   [《互联网高频面试题》](http://mp.weixin.qq.com/s?__biz=MzUxOTc4NjEyMw==&mid=2247561735&idx=1&sn=1b0a95d87fc647c3cf5e2b88576a8f55&chksm=f9f7e9e3ce8060f5809daa189fea465e95fa5445797f96fd8023f424c2acf4d31751a62792fc&scene=21#wechat_redirect)：面朝简历学习，春暖花开
>     
> *   [《架构 x 系统设计》](http://mp.weixin.qq.com/s?__biz=MzUxOTc4NjEyMw==&mid=2247561735&idx=1&sn=1b0a95d87fc647c3cf5e2b88576a8f55&chksm=f9f7e9e3ce8060f5809daa189fea465e95fa5445797f96fd8023f424c2acf4d31751a62792fc&scene=21#wechat_redirect)：摧枯拉朽，掌控面试高频场景题
>     
> *   [《精进 Java 学习指南》](http://mp.weixin.qq.com/s?__biz=MzUxOTc4NjEyMw==&mid=2247561735&idx=1&sn=1b0a95d87fc647c3cf5e2b88576a8f55&chksm=f9f7e9e3ce8060f5809daa189fea465e95fa5445797f96fd8023f424c2acf4d31751a62792fc&scene=21#wechat_redirect)：系统学习，互联网主流技术栈
>     
> *   [《必读 Java 源码专栏》](http://mp.weixin.qq.com/s?__biz=MzUxOTc4NjEyMw==&mid=2247561735&idx=1&sn=1b0a95d87fc647c3cf5e2b88576a8f55&chksm=f9f7e9e3ce8060f5809daa189fea465e95fa5445797f96fd8023f424c2acf4d31751a62792fc&scene=21#wechat_redirect)：知其然，知其所以然
>     

![](https://mmbiz.qpic.cn/mmbiz_gif/JdLkEI9sZfdWPYr0VKaXztEGHacpRyle7tbZkryrsxIpnAfjRt03ibrcloEZqlRPaVKcb0nD2PrYjtovwOAaFlA/640?wx_fmt=gif)

> 👉**这是一个或许对你有用的开源项目**
> 
> 国产 Star 破 10w+ 的开源项目，前端包括管理后台 + 微信小程序，后端支持单体和微服务架构。
> 
> 功能涵盖 RBAC 权限、SaaS 多租户、数据权限、商城、支付、工作流、大屏报表、微信公众号等等功能：
> 
> *   Boot 仓库：https://gitee.com/zhijiantianya/ruoyi-vue-pro
>     
> *   Cloud 仓库：https://gitee.com/zhijiantianya/yudao-cloud
>     
> *   视频教程：https://doc.iocoder.cn
>     
> 
> 【国内首批】支持 JDK 21 + SpringBoot 3.2.2、JDK 8 + Spring Boot 2.7.18 双版本 

[来源：developer.jdcloud.  
com/article/2776](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)

*   [缓存不一致是如何产生的](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect)
    
*   [缓存更新的几种设计](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect)
    
*   [总结](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect)
    

* * *

先阐明一下 Mysql 和 Redis 的关系：Mysql 是数据库，用来持久化数据，一定程度上保证数据的可靠性；Redis 是用来当缓存，用来提升数据访问的性能。

关于如何保证 Mysql 和 Redis 中的数据一致（即缓存一致性问题），这是一个非常经典的问题。

使用过缓存的人都应该知道，在实际应用场景中，要想实时刻保证缓存和数据库中的数据一样，很难做到。

基本上都是尽可能让他们的数据在绝大部分时间内保持一致，并保证最终是一致的。

[缓存不一致是如何产生的](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)
--------------------------------------------------------------------------------------------------------------------------------------------------

如果数据一直没有变更，那么就不会出现缓存不一致的问题。

通常缓存不一致是发生在数据有变更的时候。因为每次数据变更你需要同时操作数据库和缓存，而他们又属于不同的系统，无法做到同时操作成功或失败，总会有一个时间差。在并发读写的时候可能就会出现缓存不一致的问题（理论上通过分布式事务可以保证这一点，不过实际上基本上很少有人这么做）。

虽然没办法在数据有变更时，保证缓存和数据库强一致，但对缓存的更新还是有一定设计方法的，遵循这些设计方法，能够让这个不一致的影响时间和影响范围最小化。

> 基于 Spring Boot + MyBatis Plus + Vue & Element 实现的后台管理系统 + 用户小程序，支持 RBAC 动态权限、多租户、数据权限、工作流、三方登录、支付、短信、商城等功能
> 
> *   项目地址：https://github.com/YunaiV/ruoyi-vue-pro
>     
> *   视频教程：https://doc.iocoder.cn/video/
>     

[缓存更新的几种设计](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)
------------------------------------------------------------------------------------------------------------------------------------------------

缓存更新的设计方法大概有以下四种：

*   先删除缓存，再更新数据库（这种方法在并发下最容易出现长时间的脏数据，不可取）
    
*   先更新数据库，删除缓存（Cache Aside Pattern）
    
*   只更新缓存，由缓存自己同步更新数据库（Read/Write Through Pattern）
    
*   只更新缓存，由缓存自己异步更新数据库（Write Behind Cache Pattern）
    

接下来详细介绍一些这四种设计方法

#### [先删除缓存，再更新数据库](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)

这种方法在并发读写的情况下容易出现缓存不一致的问题

![](https://mmbiz.qpic.cn/mmbiz_png/6mychickmupV3H8DI23vZHAzpvU4w2icyUlXGJmuicIJnibXY6aS3jINYEJf6qeZc1icLrFxJDlIOgWobLzlKjbklAQ/640?wx_fmt=png&from=appmsg)

如上图所示，其可能的执行流程顺序为：

*   客户端 1 触发更新数据 A 的逻辑
    
*   客户端 2 触发查询数据 A 的逻辑
    
*   客户端 1 删除缓存中数据 A
    
*   客户端 2 查询缓存中数据 A，未命中
    
*   客户端 2 从数据库查询数据 A，并更新到缓存中
    
*   客户端 1 更新数据库中数据 A
    

可见，最后缓存中的数据 A 跟数据库中的数据 A 是不一致的，缓存中的数据 A 是旧的脏数据。

因此一般不建议使用这种方式。

#### [先更新数据库，再让缓存失效](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)

这种方法在并发读写的情况下，也可能会出现短暂缓存不一致的问题

![](https://mmbiz.qpic.cn/mmbiz_png/6mychickmupV3H8DI23vZHAzpvU4w2icyUG8z3KqYlZnUD7Yq84SiaDRPl32joej00oWiaQcWicoV9pxg2W1FBSqic1g/640?wx_fmt=png&from=appmsg)

如上图所示，其可能执行的流程顺序为：

*   客户端 1 触发更新数据 A 的逻辑
    
*   客户端 2 触发查询数据 A 的逻辑
    
*   客户端 3 触发查询数据 A 的逻辑
    
*   客户端 1 更新数据库中数据 A
    
*   客户端 2 查询缓存中数据 A，命中返回（旧数据）
    
*   客户端 1 让缓存中数据 A 失效
    
*   客户端 3 查询缓存中数据 A，未命中
    
*   客户端 3 查询数据库中数据 A，并更新到缓存中
    

可见，最后缓存中的数据 A 和数据库中的数据 A 是一致的，理论上可能会出现一小段时间数据不一致，不过这种概率也比较低，大部分的业务也不会有太大的问题。

#### [只更新缓存，由缓存自己同步更新数据](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)

这种方法相当于是业务只更新缓存，再由缓存去同步更新数据库。一个 Write Through 的 例子如下：

![](https://mmbiz.qpic.cn/mmbiz_png/6mychickmupV3H8DI23vZHAzpvU4w2icyUfPyjia9NGibZt41dnicYhS55PdicSUmbU5Fib50uxG8ajA6TvSwJnXRtQeA/640?wx_fmt=png&from=appmsg)

如上图所示，其可能执行的流程顺序为：

*   客户端 1 触发更新数据 A 的逻辑
    
*   客户端 2 触发查询数据 A 的逻辑
    
*   客户端 1 更新缓存中数据 A，缓存同步更新数据库中数据 A，再返回结果
    
*   客户端 2 查询缓存中数据 A，命中返回
    

Read Through 和 WriteThrough 的流程类似，只是在客户端查询数据 A 时，如果缓存中数据 A 失效了（过期或被驱逐淘汰），则缓存会同步去数据库中查询数据 A，并缓存起来，再返回给客户端

这种方式缓存不一致的概率极低，只不过需要对缓存进行专门的改造。

#### [只更新缓存，由缓存自己异步更新数据库](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)

这种方式性详单于是业务只操作更新缓存，再由缓存异步去更新数据库，例如：

![](https://mmbiz.qpic.cn/mmbiz_png/6mychickmupV3H8DI23vZHAzpvU4w2icyUF6qCibRdBbCRqBiasySeXasg99WeiavibLP0ygtSNCibPkicakQl35zWnLZg/640?wx_fmt=png&from=appmsg)

如上图所示，其可能的执行流程顺序为：

*   客户端 1 触发更新数据 A 的逻辑
    
*   客户端 2 触发查询数据 A 的逻辑
    
*   客户端 1 更新缓存中的数据 A，返回
    
*   客户端 2 查询缓存中的数据 A，命中返回
    
*   缓存异步更新数据 A 到数据库中
    

这种方式的优势是读写的性能都非常好，基本上只要操作完内存后就返回给客户端了，但是其是非强一致性，存在丢失数据的情况。

如果在缓存异步将数据更新到数据库中时，缓存服务挂了，此时未更新到数据库中的数据就丢失了。

> 基于 Spring Cloud Alibaba + Gateway + Nacos + RocketMQ + Vue & Element 实现的后台管理系统 + 用户小程序，支持 RBAC 动态权限、多租户、数据权限、工作流、三方登录、支付、短信、商城等功能
> 
> *   项目地址：https://github.com/YunaiV/yudao-cloud
>     
> *   视频教程：https://doc.iocoder.cn/video/
>     

[总结](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)
-----------------------------------------------------------------------------------------------------------------------------------------

上面讲到的几种缓存更新的设计方式，都是前人总结出来的经验，这些方式或多或少都有一些弊端，并不完美，实际上也很难有完美的设计。

大家在做系统设计的时候，也不要去追求完美，要有一些取舍，找到一种最适合自己业务场景的方式就行

* * *

欢迎加入我的知识星球，全面提升技术能力。

👉 加入方式，**“**长按**” 或 “**扫描**” 下方二维码噢**：

![](https://mmbiz.qpic.cn/mmbiz_png/6mychickmupUyQRGCOLQlJYyS47picY3OzaoUUJvwwrgEyR5U5fcYrCggDvjuDmAtibib1Zf6JjXlOic1PfvRCF2l4A/640?wx_fmt=png)

星球的**内容包括**：项目实战、面试招聘、源码解析、学习路线。

![](https://mmbiz.qpic.cn/mmbiz_png/JdLkEI9sZfdWPYr0VKaXztEGHacpRyle64G451XsWx4Ufc9FHYmNTqFdKdtNhyjlhrEC7Pic1dRfue78ib3TiaKBg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/JdLkEI9sZfdWPYr0VKaXztEGHacpRylewlfAU6nBKS8tWSIrLcmSicsq0ECUIVnf0JHibsLARrp4Z3ZCh5oSvYMQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/JdLkEI9sZfdWPYr0VKaXztEGHacpRyleptHSrmBV71SbQSolzZpmdqN2q03yLwk1bwZYNu2lr17gFjO0rh1ZdQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/JdLkEI9sZfdWPYr0VKaXztEGHacpRyleYQLfl6qLTABQx5UrP0dXXv6cSv2TmBoouiciaZIXwyD88h5OIsM8lpkw/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/JdLkEI9sZfdWPYr0VKaXztEGHacpRyleicAvrkTkdGYRubqZdPNkqpoTmtOCQjkItotwtAbCxibsWUI4Dz0ILTEg/640?wx_fmt=png)

```
文章有帮助的话，在看，转发吧。

谢谢支持哟 (*^__^*）

```