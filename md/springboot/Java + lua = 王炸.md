> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/w-brbFhEKWscX1LLDO9PqA)

> 👉 **这是一个或许对你有用****的社群**
> 
> 🐱 一对一交流 / 面试小册 / 简历优化 / 求职解惑，欢迎加入「[**芋道快速开发平台**](http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247576697&idx=1&sn=a5f8a37fe0c6f05509c5bed6244471a8&chksm=fa4bd3c8cd3c5aded28a6b68a9944ce671f3d2748644f71550c0468d75058e90dd378a1babe8&scene=21#wechat_redirect)」知识星球。下面是星球提供的部分资料： 
> 
> *   [《项目实战（视频）》](http://mp.weixin.qq.com/s?__biz=MzUxOTc4NjEyMw==&mid=2247561735&idx=1&sn=1b0a95d87fc647c3cf5e2b88576a8f55&chksm=f9f7e9e3ce8060f5809daa189fea465e95fa5445797f96fd8023f424c2acf4d31751a62792fc&scene=21#wechat_redirect)：从书中学，往事中 **“练”**
>     
> *   [《互联网高频面试题》](http://mp.weixin.qq.com/s?__biz=MzUxOTc4NjEyMw==&mid=2247561735&idx=1&sn=1b0a95d87fc647c3cf5e2b88576a8f55&chksm=f9f7e9e3ce8060f5809daa189fea465e95fa5445797f96fd8023f424c2acf4d31751a62792fc&scene=21#wechat_redirect)：面朝简历学习，春暖花开
>     
> *   [《架构 x 系统设计》](http://mp.weixin.qq.com/s?__biz=MzUxOTc4NjEyMw==&mid=2247561735&idx=1&sn=1b0a95d87fc647c3cf5e2b88576a8f55&chksm=f9f7e9e3ce8060f5809daa189fea465e95fa5445797f96fd8023f424c2acf4d31751a62792fc&scene=21#wechat_redirect)：摧枯拉朽，掌控面试高频场景题
>     
> *   [《精进 Java 学习指南》](http://mp.weixin.qq.com/s?__biz=MzUxOTc4NjEyMw==&mid=2247561735&idx=1&sn=1b0a95d87fc647c3cf5e2b88576a8f55&chksm=f9f7e9e3ce8060f5809daa189fea465e95fa5445797f96fd8023f424c2acf4d31751a62792fc&scene=21#wechat_redirect)：系统学习，互联网主流技术栈
>     
> *   [《必读 Java 源码专栏》](http://mp.weixin.qq.com/s?__biz=MzUxOTc4NjEyMw==&mid=2247561735&idx=1&sn=1b0a95d87fc647c3cf5e2b88576a8f55&chksm=f9f7e9e3ce8060f5809daa189fea465e95fa5445797f96fd8023f424c2acf4d31751a62792fc&scene=21#wechat_redirect)：知其然，知其所以然
>     

![](https://mmbiz.qpic.cn/mmbiz_gif/JdLkEI9sZfdWPYr0VKaXztEGHacpRyle7tbZkryrsxIpnAfjRt03ibrcloEZqlRPaVKcb0nD2PrYjtovwOAaFlA/640?wx_fmt=gif)

> 👉**这是一个或许对你有用的开源项目**
> 
> 国产 Star 破 10w+ 的开源项目，前端包括管理后台 + 微信小程序，后端支持单体和微服务架构。
> 
> 功能涵盖 RBAC 权限、SaaS 多租户、数据权限、商城、支付、工作流、大屏报表、微信公众号等等功能：
> 
> *   Boot 仓库：https://gitee.com/zhijiantianya/ruoyi-vue-pro
>     
> *   Cloud 仓库：https://gitee.com/zhijiantianya/yudao-cloud
>     
> *   视频教程：https://doc.iocoder.cn
>     
> 
> 【国内首批】支持 JDK 21 + SpringBoot 3.2.0、JDK 8 + Spring Boot 2.7.18 双版本 

[来源：网络](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)

*   [luaj 主要特征](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect)
    
*   [luaj 用法示例](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect)
    
*   [luaj 实现原理](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect)
    
*   [查找并调用指定的 Java 方法](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect)
    
*   [从 Java 方法获取返回值](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect)
    
*   [将 Lua function 作为参数传递给 Java 方法](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect)
    

[![](https://mmbiz.qpic.cn/mmbiz_jpg/6mychickmupXSarUb9aiaChAT3mLOojicAyibmNVY54tibTjncErgAZszxSJ5e6ZliaQlFMeLr9WjCQkriaEibVqibwMp2w/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)

* * *

在某些业务场景下，我们可能会遇到 lua 中要调用 java 代码情况，当然这个用 JNI 肯定是可以做到的，但是有更加方便的办法：LuaJavaBridge（LuaJava）和 LuaJ。

[luaj 主要特征](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)
------------------------------------------------------------------------------------------------------------------------------------------------

*   可以从 Lua 调用 Java Class Static Method
    
*   调用 Java 方法时，支持 int/float/boolean/String/Lua function 五种参数类型
    
*   可以将 Lua function 作为参数传递给 Java，并让 Java 保存 Lua function 的引用
    
*   可以从 Java 调用 Lua 的全局函数，或者调用引用指向的 Lua function
    

luaj 的功能很简单，但对于集成各种 SDK 来说已经完全满足需求了。

> 基于 Spring Boot + MyBatis Plus + Vue & Element 实现的后台管理系统 + 用户小程序，支持 RBAC 动态权限、多租户、数据权限、工作流、三方登录、支付、短信、商城等功能
> 
> *   项目地址：https://github.com/YunaiV/ruoyi-vue-pro
>     
> *   视频教程：https://doc.iocoder.cn/video/
>     

[luaj 用法示例](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)
------------------------------------------------------------------------------------------------------------------------------------------------

Java 方法原型：

```
public static float getNum(float n) {    return n;}
```

lua 调用示例：

```
-- Java 类的名称local className = "com/xttblog/Test"-- 调用 的Java 方法名local method = 'getNum'-- 调用 Java 方法需要的参数local n = 10local args = {     n}-- 调用 Java 方法local _, testStaticMethod = luaj.callStaticMethod(className, method, args)
```

> 基于 Spring Cloud Alibaba + Gateway + Nacos + RocketMQ + Vue & Element 实现的后台管理系统 + 用户小程序，支持 RBAC 动态权限、多租户、数据权限、工作流、三方登录、支付、短信、商城等功能
> 
> *   项目地址：https://github.com/YunaiV/yudao-cloud
>     
> *   视频教程：https://doc.iocoder.cn/video/
>     

[luaj 实现原理](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)
------------------------------------------------------------------------------------------------------------------------------------------------

luaj 的核心目标有两个：从 Lua 调用 Java, 从 Java 调用 Lua。整理出来就是如下几点

*   查找并调用指定的 Java 方法
    
*   检查调用结果，并从 Java 方法获取返回值
    
*   将 Lua function 作为参数传递给 Java 方法
    
*   在 Java 方法中调用 Lua function
    

[查找并调用指定的 Java 方法](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)
-------------------------------------------------------------------------------------------------------------------------------------------------------

`JNI 提供了 FindClass() 方法用于查找指定的 Class，所以 luaj.callStaticMethod() 的第一个参数就是要调用的 Java Class 的完整类名称（类名称中的“.”要替换为“/”）`。

找到指定 Class 后，利用 JNI 的 GetStaticMethodID() 方法就可以找到这个类的指定静态方法，前提是要提供静态方法的名称和签名。

所谓签名，就是指 Java 方法的参数类型和返回类型定义。方法的签名就是类似`(Ljava/lang/String;ZZI)V`这样的一串描述，通过字节码方式可以查看，如下示例：

![](https://mmbiz.qpic.cn/mmbiz_png/6mychickmupXSarUb9aiaChAT3mLOojicAyRaWE8GicE2bC4JW16FIEib2dXT7MZOEDFhPwpgw1DDmVsbsAgyCiaf4GA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

关于 Java 方法签名的具体定义，可以参考：`JNI Type Signatures`。

这里要说的是 luaj 可以根据调用参数自动猜测方法签名所以示例中我们并没有写签名。

示例中指定参数：

```
local args = {n}<br style="outline: 0px;">
```

luaj 根据这 个参数，会构造出正确的方法签名。

注意：这里要说的是 Lua 里没有办法准确判断一个数值是整数还是浮点数，所以 luaj 在猜测方法签名时，假定所有的数值都是浮点数。所以下面调用会报错：

```
public static int getNum(int n) {  return n;}-- Java 类的名称local className = "com/xttblog/Test"-- 调用 的Java 方法名local method = 'getNum'-- 调用 Java 方法需要的参数local n = 10local args = {     n}-- 调用 Java 方法local _, testStaticMethod = luaj.callStaticMethod(className, method, args)
```

这样是不行的，所以这个时候我们要自己定义签名。

下面给出正确的示例

```
public static int getNum(int n) {  return n;}-- Java 类的名称local className = "com/xttblog/Test"-- 调用 的Java 方法名local method = 'getNum'-- 调用 Java 方法需要的参数local n = 10local args = {     n}-- 定义签名-- 参数: [I]nteger-- 返回值: [I]ntlocal sig = "(I)I"-- 调用 Java 方法local _, testStaticMethod = luaj.callStaticMethod(className, method, args，sig)
```

签名使用 “(依次排列的参数类型) 返回值类型”的格式，几个例子如下：

```
签名                                         解释()V                             参数：无，返回值：无(I)V                            参数：int，返回值：无(Ljava/lang/String;)Z           参数：字符串，返回值：布尔值(IF)Ljava/lang/String;          参数：整数、浮点数，返回值：字符串
```

这里列出不同类型对应的 Java 签名字符串：

```
类型名                 类型<br style="outline: 0px;">I                       整数，或者 Lua function<br style="outline: 0px;">F                       浮点数<br style="outline: 0px;">Z                       布尔值<br style="outline: 0px;">Ljava/lang/String;      字符串<br style="outline: 0px;">V                       Void 空，仅用于指定一个 Java 方法不返回任何值<br style="outline: 0px;">
```

Java 方法里接收 Lua function 的参数必须定义为 int 类型

[从 Java 方法获取返回值](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)
-----------------------------------------------------------------------------------------------------------------------------------------------------

luaj 会检查调用结果，并从 Java 方法获取返回值。

luaj 调用 Java 方法时，可能会出现各种错误，因此 luaj 提供了一种机制让 Lua 调用代码可以确定 Java 方法是否成功调用。

`luaj.callStaticMethod()`会返回两个值：

*   当成功时，第一个值为 true，第二个值是 Java 方法的返回值（如果有）。
    
*   当失败时，第一个值为 false，第二个值是错误代码。
    

下面的代码展示了如何检查返回结果和获得返回值：

```
public static int AddTwoNumbers(final int number1, final int number2) {  return number1 + number2;}
```

Lua 代码

```
local args = {2, 3}local sig = "(II)I"local ok, ret = luaj.callStaticMethod(className, "AddTwoNumbers", args, sig)if not ok thenprint("luaj error:", ret)elseprint("ret:", ret) -- 输出 ret: 5end
```

错误代码定义如下：

```
错误代码                            描述-1                          不支持的参数类型或返回值类型-2                          无效的签名-3                          没有找到指定的方法-4                          Java 方法执行时抛出了异常-5                          Java 虚拟机出错-6                          Java 虚拟机出错
```

[将 Lua function 作为参数传递给 Java 方法](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)
---------------------------------------------------------------------------------------------------------------------------------------------------------------------

Lua 虚拟机中，Lua function 以值的形式保存。但这个值无法直接给 Java 用，所以 luaj 做了一个 Lua function 引用表。当一个 Lua function 传递给 Java 时，这个 function 对应的值会被存在引用表中，并获得一个唯一的引用 ID （整数）。Java 代码拿到这个引用 ID 后，就可以很方便的调用该 Lua function 了。

所以 Java 方法里接收 Lua function 的参数必须定义为 int 类型。

示例：

```
public static int getNum(int n) {  return n;}local function callback(result)     ---方法内容end-- Java 类的名称local className = "com/xttblog/Test"-- 调用 的Java 方法名local method = 'getNum'-- 调用 Java 方法需要的参数local args = {     callback}-- 定义签名-- 参数: [I]nteger-- 返回值: [I]ntlocal sig = "(I)I"-- 调用 Java 方法local _, testStaticMethod = luaj.callStaticMethod(className, method, args，sig)
```

另外，LuaJ 也很好用。只需引入 pom。

![](https://mmbiz.qpic.cn/mmbiz_png/6mychickmupXSarUb9aiaChAT3mLOojicAy2jlpG99IABCY7qEnSnzZTWGtaEwCQxw6U9XLibbTic0X6gNVefzrwlrQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

然后直接把 lua 代码当做 String 字符串内嵌到 Java 代码中：

```
String luaStr = "print 'hello,world!'";Globals globals = JsePlatform.standardGlobals();LuaValue chunk = globals.load(luaStr);chunk.call();
```

也可以创建一个 login.lua 脚本，内容如下：

```
--无参函数   function hello()      print 'hello'   end--带参函数   function test(str)      print('data from java is:'..str)      return 'haha'   end
```

然后，Java 先载入 login.lua 脚本并编译，然后再获取指定名称的函数，无参的直接使用 call() 方法调用，带参的需要通过 invoke(LuaValue[]) 传入参数表：

```
String luaPath = "res/lua/login.lua"; //lua脚本文件所在路径   Globals globals = JsePlatform.standardGlobals();//加载脚本文件login.lua，并编译globals.loadfile(luaPath).call();//获取无参函数helloLuaValue func = globals.get(LuaValue.valueOf("hello"));//执行hello方法func.call();//获取带参函数testLuaValue func1 = globals.get(LuaValue.valueOf("test"));//执行test方法,传入String类型的参数参数String data = func1.call(LuaValue.valueOf("I'am from Java!")).toString();   //打印lua函数回传的数据   Logger.info("data return from lua is:"+data);
```

运行结果如下：

```
hellodata from java is:I'am from Java!八月 07, 2022 5:31:25 下午 com.tw.login.tools.Logger info信息: lua return data：haha
```

![](https://mmbiz.qpic.cn/mmbiz_png/6mychickmupXSarUb9aiaChAT3mLOojicAyyYtBdevS20ksHVmeMG5yib0kN6wWqW2AlicY8J5iazhWf21g85FZXw8eg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

* * *

欢迎加入我的知识星球，全面提升技术能力。

👉 加入方式，**“**长按**” 或 “**扫描**” 下方二维码噢**：

![](https://mmbiz.qpic.cn/mmbiz_png/6mychickmupUyQRGCOLQlJYyS47picY3OzaoUUJvwwrgEyR5U5fcYrCggDvjuDmAtibib1Zf6JjXlOic1PfvRCF2l4A/640?wx_fmt=png)

星球的**内容包括**：项目实战、面试招聘、源码解析、学习路线。

![](https://mmbiz.qpic.cn/mmbiz_png/JdLkEI9sZfdWPYr0VKaXztEGHacpRyle64G451XsWx4Ufc9FHYmNTqFdKdtNhyjlhrEC7Pic1dRfue78ib3TiaKBg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/JdLkEI9sZfdWPYr0VKaXztEGHacpRylewlfAU6nBKS8tWSIrLcmSicsq0ECUIVnf0JHibsLARrp4Z3ZCh5oSvYMQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/JdLkEI9sZfdWPYr0VKaXztEGHacpRyleptHSrmBV71SbQSolzZpmdqN2q03yLwk1bwZYNu2lr17gFjO0rh1ZdQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/JdLkEI9sZfdWPYr0VKaXztEGHacpRyleYQLfl6qLTABQx5UrP0dXXv6cSv2TmBoouiciaZIXwyD88h5OIsM8lpkw/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/JdLkEI9sZfdWPYr0VKaXztEGHacpRyleicAvrkTkdGYRubqZdPNkqpoTmtOCQjkItotwtAbCxibsWUI4Dz0ILTEg/640?wx_fmt=png)

```
文章有帮助的话，在看，转发吧。

谢谢支持哟 (*^__^*）

```